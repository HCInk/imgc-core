pipeline{
	agent none
	options {
        gitLabConnection('gitlab.com')
        gitlabBuilds(builds: ['Build'])
    }
    triggers {
        gitlab(triggerOnPush: true, triggerOnMergeRequest: true, branchFilterType: 'All')
    }
	stages{
		stage("Build"){
			agent { dockerfile {
				filename '.ci/Dockerfiles/Build'
				args: '-u root'
				} }
			steps{
				sh 'umask 000'
				sh "./setup.sh"
				sh "./build.sh"
			}
			post{
				success{
					archiveArtifacts artifacts: 'build/libimgc.so', fingerprint: true
					updateGitlabCommitStatus name: 'Build', state: 'success'
				}
				failure{
					updateGitlabCommitStatus name: 'Build', state: 'failed'
				}
			}
		}
	}
}